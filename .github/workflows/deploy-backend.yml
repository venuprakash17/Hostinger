name: Deploy Backend to Hostinger VPS

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy backend to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        source: "backend/*"
        target: ${{ secrets.VPS_BACKEND_PATH || '/home/root/elevate-edu-backend/backend' }}
        overwrite: true

    - name: Setup backend on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          BACKEND_PATH="${{ secrets.VPS_BACKEND_PATH || '/home/root/elevate-edu-backend/backend' }}"
          SERVICE_NAME="${{ secrets.VPS_SUPERVISOR_SERVICE || 'elevate-edu-backend' }}"
          
          cd $BACKEND_PATH
          
          echo "üì¶ Create venv if not exists"
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi

          echo "üìå Activate venv"
          source venv/bin/activate

          echo "‚¨Ü Upgrade pip"
          pip install --upgrade pip

          echo "üì• Install/Update dependencies"
          pip install -r requirements.txt

          echo "üóÑÔ∏è Create database tables if needed"
          python -c "from app.core.database import Base, engine; Base.metadata.create_all(bind=engine)" || echo "‚ö†Ô∏è Table creation skipped (might already exist)"

          echo "üîÑ Restarting Supervisor service: $SERVICE_NAME"
          sudo supervisorctl reread || true
          sudo supervisorctl update || true
          sudo supervisorctl restart $SERVICE_NAME || echo "‚ö†Ô∏è Service restart failed, check supervisor config"
          
          echo "‚úÖ Backend deployed successfully!"
